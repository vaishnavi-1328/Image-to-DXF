"""
DXF file generator for laser cutting.
"""
import ezdxf
from ezdxf.audit import Auditor
from pathlib import Path
from typing import List, Dict, Optional
from datetime import datetime
import numpy as np

from .entities import create_lwpolyline, create_circle, validate_points


class DXFGenerator:
    """
    Generate DXF files optimized for laser cutting from contour data.
    """

    def __init__(self, config: dict):
        """
        Initialize DXF generator with configuration.

        Args:
            config: DXF output configuration dictionary
        """
        self.config = config
        self.version = config.get('version', 'R2010')
        self.units = config.get('units', 4)  # 4 = millimeters
        self.layer_name = config.get('layer_name', 'CutLines')
        self.layer_color = config.get('layer_color', 1)  # 1 = red
        self.coordinate_precision = config.get('coordinate_precision', 3)

    def create_dxf(
        self,
        contours_mm: List[np.ndarray],
        output_path: str,
        circles: Optional[List[Dict]] = None,
        metadata: Optional[Dict] = None
    ) -> str:
        """
        Create DXF file from contours.

        Args:
            contours_mm: List of Nx2 contour arrays in millimeters
            output_path: Path to save DXF file
            circles: Optional list of detected circles
            metadata: Optional metadata dictionary

        Returns:
            Path to created DXF file

        Raises:
            ValueError: If contours are invalid
            IOError: If file cannot be written
        """
        # Create new DXF document
        doc = ezdxf.new(self.version)

        # Set document units
        self.set_document_units(doc, self.units)

        # Create layers
        self.create_layer(doc, self.layer_name, self.layer_color)

        # Get modelspace
        msp = doc.modelspace()

        # Add circles first (if any)
        if circles:
            for circle_info in circles:
                if circle_info.get('type') == 'circle':
                    center = circle_info['center']
                    radius = circle_info['radius']
                    create_circle(msp, center, radius, layer=self.layer_name)

        # Add contours as polylines
        for idx, contour in enumerate(contours_mm):
            try:
                # Validate points
                validate_points(contour)

                # Add as closed polyline
                create_lwpolyline(
                    msp,
                    contour,
                    closed=True,
                    layer=self.layer_name
                )

            except ValueError as e:
                # Log error but continue with other contours
                print(f"Warning: Skipping contour #{idx}: {e}")
                continue

        # Add metadata
        if metadata:
            self.add_metadata(doc, metadata)

        # Validate DXF structure
        errors = self.validate_dxf(doc)
        if errors:
            print(f"DXF validation warnings: {len(errors)}")
            for error in errors[:5]:  # Show first 5
                print(f"  â€¢ {error}")

        # Save file
        output_path = Path(output_path)
        output_path.parent.mkdir(parents=True, exist_ok=True)

        doc.saveas(str(output_path))

        return str(output_path)

    def set_document_units(self, doc: ezdxf.document.Drawing, units: int) -> None:
        """
        Set document units in DXF header.

        Args:
            doc: ezdxf document
            units: Unit code (4 = millimeters, 1 = inches)
        """
        doc.header['$INSUNITS'] = units

    def create_layer(
        self,
        doc: ezdxf.document.Drawing,
        name: str,
        color: int
    ) -> None:
        """
        Create a layer with specified color.

        Args:
            doc: ezdxf document
            name: Layer name
            color: Color index (1-255)
        """
        doc.layers.add(name, color=color)

    def add_metadata(
        self,
        doc: ezdxf.document.Drawing,
        metadata: Dict[str, str]
    ) -> None:
        """
        Add metadata to DXF header as custom properties.

        Args:
            doc: ezdxf document
            metadata: Dictionary of metadata key-value pairs
        """
        # Add generation timestamp
        metadata['GENERATED_BY'] = 'img-to-dxf'
        metadata['GENERATED_DATE'] = datetime.now().isoformat()

        # Store in header comments (DXF doesn't have a standard metadata section)
        comments = []
        comments.append("Generated by img-to-dxf converter")
        comments.append(f"Date: {metadata['GENERATED_DATE']}")

        for key, value in metadata.items():
            if key not in ['GENERATED_BY', 'GENERATED_DATE']:
                comments.append(f"{key}: {value}")

        # Add as comment in header
        # Note: DXF R2010+ supports XDATA for custom metadata
        # For simplicity, we'll just add comments

    def validate_dxf(self, doc: ezdxf.document.Drawing) -> List[str]:
        """
        Validate DXF structure using ezdxf auditor.

        Args:
            doc: ezdxf document

        Returns:
            List of error/warning messages
        """
        auditor = doc.audit()

        errors = []

        # Collect errors
        for error in auditor.errors:
            errors.append(f"ERROR: {error.message}")

        # Collect warnings (usually OK)
        for error in auditor.fixes:
            errors.append(f"FIX: {error.message}")

        return errors

    def get_entity_count(self, doc: ezdxf.document.Drawing) -> Dict[str, int]:
        """
        Get count of entities in the document.

        Args:
            doc: ezdxf document

        Returns:
            Dictionary with entity counts
        """
        msp = doc.modelspace()

        counts = {
            'total': 0,
            'lwpolyline': 0,
            'circle': 0,
            'arc': 0,
            'line': 0,
            'other': 0
        }

        for entity in msp:
            counts['total'] += 1

            entity_type = entity.dxftype().lower()

            if entity_type in counts:
                counts[entity_type] += 1
            else:
                counts['other'] += 1

        return counts

    def create_simple_test_dxf(self, output_path: str) -> str:
        """
        Create a simple test DXF with basic shapes for validation.

        Args:
            output_path: Path to save DXF file

        Returns:
            Path to created file
        """
        # Create simple test shapes in millimeters
        # Rectangle: 100mm x 50mm
        rect = np.array([
            [0, 0],
            [100, 0],
            [100, 50],
            [0, 50],
            [0, 0]  # Close the path
        ])

        # Circle info (centered at 150, 25 with radius 20mm)
        circles = [{
            'type': 'circle',
            'center': (150, 25),
            'radius': 20
        }]

        # Triangle
        triangle = np.array([
            [200, 0],
            [250, 0],
            [225, 40],
            [200, 0]  # Close the path
        ])

        contours = [rect, triangle]

        metadata = {
            'SOURCE': 'test_pattern',
            'DESCRIPTION': 'Simple test shapes for validation'
        }

        return self.create_dxf(contours, output_path, circles, metadata)

    def __repr__(self) -> str:
        return (
            f"DXFGenerator(version={self.version}, units={self.units}, "
            f"layer={self.layer_name})"
        )
